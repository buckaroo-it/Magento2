name: Module checks
on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  workflow_dispatch:

# Prevent duplicate runs: cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2, phpunit, phpcs
          coverage: none

      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate composer.json
        run: composer validate

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/${{ env.namespace }}-source/vendor
          key: ${{ runner.os }}-php84-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php84-

      - name: Prepare auth for Magento repo
        run: |
          printf '%s\n' \
          '{' \
          '  "http-basic": {' \
          '    "repo.magento.com": {' \
          '      "username": "${{ secrets.REPO_USERNAME }}",' \
          '      "password": "${{ secrets.REPO_PASS }}"' \
          '    }' \
          '  }' \
          '}' > auth.json

      - name: Determine changed files (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          pull_number=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          url="https://api.github.com/repos/${{ github.repository }}/pulls/$pull_number/files"
          echo "$url"
          curl -sS "$url" > files_changed
          cat files_changed | grep '"filename"' | sed 's/\"filename\"\: \"//' | sed 's/\",//' | xargs -r ls -la

      - name: Create Magento 2.4.8-p3 project
        run: |
          composer create-project --repository-url=https://repo.magento.com/ \
            magento/project-community-edition=2.4.8-p3 m248

      - name: Copy module into Magento
        run: |
          mkdir -p m248/app/code/Buckaroo/Magento2/
          rsync -r --exclude='m248' ./ m248/app/code/Buckaroo/Magento2/

      - name: Run PHPCS against changed files (PR) or whole module (push)
        run: |
          if [ -f files_changed ]; then
            cat files_changed | grep '"filename"' | sed 's/\"filename\"\: \"//' | sed 's/\",//' \
              | xargs -r ./m248/vendor/bin/phpcs --standard=Magento2
          else
            ./m248/vendor/bin/phpcs --standard=Magento2 m248/app/code/Buckaroo/Magento2
          fi

      - name: Compile and run unit tests
        working-directory: m248
        run: |
          bin/magento module:enable --all
          bin/magento setup:di:compile
          vendor/phpunit/phpunit/phpunit -c dev/tests/unit/phpunit.xml.dist app/code/Buckaroo/Magento2
