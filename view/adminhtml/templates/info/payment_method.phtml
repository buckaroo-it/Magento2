<?php
/**
 * NOTICE OF LICENSE
 *
 * This source file is subject to the MIT License
 * It is available through the world-wide-web at this URL:
 * https://tldrlegal.com/license/mit-license
 * If you are unable to obtain it through the world-wide-web, please send an email
 * to support@buckaroo.nl so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this module to newer
 * versions in the future. If you wish to customize this module for your
 * needs please contact support@buckaroo.nl for more information.
 *
 * @copyright Copyright (c) Buckaroo B.V.
 * @license   https://tldrlegal.com/license/mit-license
 */

// @codingStandardsIgnoreFile
/**
 * @var $block \Buckaroo\Magento2\Block\Info
 */
?>
<?php /** @var \Buckaroo\Magento2\Model\Method\BuckarooAdapter $method */ ?>
<?php
// Check if this is a mixed payment (group transaction with multiple payment methods)
$allPaymentMethods = $block->getAllGroupTransactionPaymentMethods();
if (!empty($allPaymentMethods)) {
    // Display all payment methods for mixed payments
    foreach ($allPaymentMethods as $paymentMethod) { ?>
        <div class="bk-payment-wrap">
            <div class="bk-img-wrap">
                <?php if ($paymentMethod['type'] === 'giftcard'): ?>
                    <img src="<?php echo $block->escapeHtml($block->getGiftcardLogo($paymentMethod)) ?>" alt=""/>
                <?php else: ?>
                    <img src="<?php echo $block->escapeHtml($block->getPaymentLogo($paymentMethod['code'])) ?>" alt=""/>
                <?php endif; ?>
            </div>
            <div class="bk-label-wrap">
                <?php echo $block->escapeHtml($paymentMethod['label']) ?>
                <?php if (isset($paymentMethod['amount'])): ?>
                    <span style="color: #666; font-size: 0.9em;"> (â‚¬<?php echo $block->escapeHtml(number_format((float)$paymentMethod['amount'], 2)) ?>)</span>
                <?php endif; ?>
            </div>
        </div>
        <?php
    }
} elseif ($giftCards = $block->getGiftCards()) {
    // Fallback to old logic for giftcard-only payments (backward compatibility)
    foreach ($giftCards as $giftCard) { ?>
        <div class="bk-payment-wrap">
            <div class="bk-img-wrap">
                <img src=" <?php echo $block->escapeHtml($block->getGiftcardLogo($giftCard)) ?>" alt=""/>
            </div>
            <div class="bk-label-wrap">
                <?php echo $block->escapeHtml($giftCard['label']) ?>
            </div>
        </div>
        <?php
    }
    $additionalInfo = $block->getGiftcardAdditionalData();
    if ($additionalInfo && isset($additionalInfo['method_title'])) {
        $methodTitle = $block->getPaymentLogo(strtolower(str_replace('Buckaroo ', '', $additionalInfo['method_title'])));
        ?>
        <div class="bk-payment-wrap">
            <div class="bk-img-wrap">
                <img src=" <?php echo $block->escapeHtml($methodTitle) ?>" alt=""/>
            </div>
            <div class="bk-label-wrap">
                <?php echo $block->escapeHtml($additionalInfo['method_title']) ?>
            </div>
        </div>
        <?php
    }
}
?>

<?php
if ($method = $block->getPayPerEmailMethod()) { ?>
    <div class="buckaroo_magento2_payment_">
        <?php echo $block->escapeHtml($method['label']) ?>
    </div>
<?php } ?>

<?php $method = $block->getMethod(); ?>
<?php // Only show this section if we haven't already displayed payment methods via group transactions ?>
<?php if (empty($allPaymentMethods)): ?>
    <?php 
    // If payment method is giftcards/voucher but no group transactions exist,
    // it means the user selected giftcard but paid with something else (e.g., full payment via iDEAL)
    // In this case, we should show the ACTUAL payment method used
    $hasGroupTransactions = !empty($block->getGiftCards());
    $showPaymentMethod = $method->buckarooPaymentMethodCode !== 'voucher' 
                         && $method->buckarooPaymentMethodCode !== 'giftcards';
    
    $displayCode = $method->buckarooPaymentMethodCode;
    $displayTitle = $block->getMethod()->getTitle();
    
    // Edge case: giftcards method selected but no actual giftcards used
    // Get the actual payment method from transaction details
    if (!$showPaymentMethod && !$hasGroupTransactions) {
        $actualMethod = $block->getActualPaymentMethodFromTransaction();
        if ($actualMethod) {
            $displayCode = $actualMethod['code'];
            $displayTitle = $actualMethod['label'];
            $showPaymentMethod = true;
        } else {
            // Fallback: still show the selected method
            $showPaymentMethod = true;
        }
    }
    ?>
    <div class="bk-payment-wrap">
        <?php if ($showPaymentMethod) { ?>
            <div class="bk-img-wrap">
                <img src=" <?php echo $block->escapeHtml($block->getPaymentLogo($displayCode)) ?>"
                     alt=""/>
            </div>
            <div class="bk-label-wrap">
                <?php echo $block->escapeHtml($displayTitle) ?>
            </div>
        <?php } ?>
    </div>
<?php endif; ?>

<?php if ($specificPaymentDetails = $block->getSpecificPaymentDetails()) : ?>
    <div class="bk-payment-wrap">
        <?php foreach ($specificPaymentDetails as $label => $value) : ?>
            <?= $block->escapeHtml($label) ?>:
            <?= $block->escapeHtml(implode(' ', $block->getValueAsArray($value))) ?>
            <br>
        <?php endforeach; ?>
    </div>
<?php endif; ?>
